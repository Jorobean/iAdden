<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #000;
            position: fixed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }

        video::-webkit-media-controls {
            display: none !important;
        }

        /* Light overlay for PiP */
        .light-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.85);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            -webkit-user-select: none;
            user-select: none;
            -webkit-backdrop-filter: brightness(1.5);
            backdrop-filter: brightness(1.5);
            mix-blend-mode: screen;
        }

        .light-overlay.active {
            opacity: 1;
        }
        
        /* PiP mirroring for all browsers */
        video::-webkit-media-controls-container,
        video::-webkit-media-controls-start-playback-button,
        video:picture-in-picture {
            transform: scaleX(-1) !important;
        }
        
        @media all and (display-mode: picture-in-picture) {
            video {
                transform: scaleX(-1) !important;
            }
        }

        .pip-button {
            white-space: nowrap;
            display: inline-flex;
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pip-button:hover, .light-button:hover {
            background: rgba(0,0,0,0.7);
        }

        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
            z-index: 1000;
        }

        .pip-container, .light-container {
            display: flex;
            align-items: center;
        }

        .light-button {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            border: none;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .light-button svg {
            width: 28px;
            height: 28px;
            fill: white;
            transition: fill 0.3s ease;
        }

        .light-button:hover {
            background: rgba(0,0,0,0.7);
        }

        .light-button.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .light-button.active svg {
            fill: #FFD700;
        }

        .pip-button, .light-button {
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pip-button svg, .light-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }


    </style>
</head>
<body>
    <div class="video-container">
        <video id="cameraVideo" autoplay playsinline muted="true" defaultMuted disableRemotePlayback></video>
        <div class="controls-container">
            <div class="pip-container">
                <button class="pip-button" id="pipBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Picture in Picture
            </button>
            </div>
            <div class="light-container">
                <button class="light-button" id="lightBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M12 2C8.13 2 5 5.13 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.87-3.13-7-7-7zm-1 14h2v1h-2v-1zm4.34-5.66C14.39 11.17 13.37 12 12 12s-2.39-.83-3.34-1.66C7.79 9.5 7 8.36 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.36-.79 2.5-1.66 3.34zM9 19h6c.55 0 1 .45 1 1s-.45 1-1 1H9c-.55 0-1-.45-1-1s.45-1 1-1z"/>
                </svg>
            </button>
            </div>
        </div>
        <div class="light-overlay" id="lightOverlay"></div>
    </div>

    <script>
        const cameraVideo = document.getElementById('cameraVideo');
        const pipBtn = document.getElementById('pipBtn');
        let currentFacingMode = 'user';

        // Initialize camera
        async function initCamera() {
            try {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { min: 1920, ideal: 3840 },  // 4K support if available
                        height: { min: 1080, ideal: 2160 },
                        frameRate: { ideal: 60 },           // 60fps for smooth video
                        aspectRatio: 16/9,                 // Maintain aspect ratio
                        resizeMode: 'crop-and-scale'       // Ensure full coverage
                    },
                    audio: false  // Disable audio track completely
                };

                // Function to ensure highest quality
                const ensureHighQuality = async (track) => {
                    const capabilities = track.getCapabilities();
                    const settings = {
                        width: Math.min(capabilities.width?.max || 3840, 3840),
                        height: Math.min(capabilities.height?.max || 2160, 2160),
                        frameRate: Math.min(capabilities.frameRate?.max || 60, 60),
                        resizeMode: 'crop-and-scale'
                    };
                    await track.applyConstraints(settings);
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Apply highest quality settings to video track
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    await ensureHighQuality(videoTrack);
                }

                cameraVideo.srcObject = stream;
                
                // Set video element properties for better quality
                cameraVideo.setAttribute('playsinline', true);
                cameraVideo.setAttribute('webkit-playsinline', true);
                cameraVideo.style.objectFit = 'cover';

                // Hide PiP button if not supported
                if (!document.pictureInPictureEnabled) {
                    pipBtn.style.display = 'none';
                }
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }

        // PiP functionality
        pipBtn.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                        </svg>
                        Picture in Picture`;
                } else if (document.pictureInPictureEnabled) {
                    const pipWindow = await cameraVideo.requestPictureInPicture();
                    // Keep PiP video playing regardless of other media and ensure it stays muted
                    pipWindow.addEventListener('pause', () => {
                        cameraVideo.muted = true;
                        cameraVideo.play().catch(err => console.log('Playback prevented'));
                    });
                    
                    // Apply light overlay to PiP if it's active
                    if (isLightOn && document.pictureInPictureElement) {
                        document.pictureInPictureElement.style.filter = 'brightness(1.5)';
                    }

                    // Ensure audio stays muted in PiP mode
                    document.pictureInPictureElement.muted = true;
                    
                    // Ensure PiP window maintains mirroring
                    document.pictureInPictureElement.style.transform = 'scaleX(-1)';
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/>
                        </svg>
                        Exit PiP`;
                }
            } catch (err) {
                console.error('PiP error:', err);
                alert('Picture-in-Picture mode failed. This feature may not be supported in your browser.');
            }
        });

        // Handle PiP mode changes
        cameraVideo.addEventListener('leavepictureinpicture', () => {
            pipBtn.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Picture in Picture`;
        });

        // Initialize on page load
        // Handle media session
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('pause', () => {
                // Prevent default pause behavior
                cameraVideo.play().catch(err => console.log('Playback prevented'));
            });
        }

        // Ensure video keeps playing when other media starts
        cameraVideo.addEventListener('pause', (event) => {
            // If in PiP mode, force continue playing
            if (document.pictureInPictureElement === cameraVideo) {
                cameraVideo.play().catch(err => console.log('Playback prevented'));
            }
        });

                // Light control functionality with screen capture protection
        const lightBtn = document.getElementById('lightBtn');
        const lightOverlay = document.getElementById('lightOverlay');
        let isLightOn = false;

        // Style for active light button
        const setLightButtonActive = (active) => {
            lightBtn.style.background = active ? 'rgba(255,255,255,0.3)' : 'rgba(0,0,0,0.5)';
            lightBtn.style.boxShadow = active ? '0 0 15px rgba(255,255,255,0.5)' : 'none';
        };

        lightBtn.addEventListener('click', () => {
            isLightOn = !isLightOn;
            lightOverlay.classList.toggle('active', isLightOn);
            setLightButtonActive(isLightOn);
            
            // Apply light effect to PiP window if active
            if (document.pictureInPictureElement) {
                document.pictureInPictureElement.style.filter = isLightOn ? 'brightness(1.5)' : 'none';
            }
        });

        // Apply CSS properties that prevent overlay from being captured
        const applyOverlayProtection = () => {
            lightOverlay.style.webkitUserSelect = 'none';
            lightOverlay.style.userSelect = 'none';
            lightOverlay.style.webkitBackdropFilter = 'brightness(1.5)';
            lightOverlay.style.backdropFilter = 'brightness(1.5)';
            lightOverlay.style.mixBlendMode = 'screen';
        };

        // Initialize overlay protection
        applyOverlayProtection();

        // Initialize on load
        window.addEventListener('load', initCamera);

        // Handle iOS orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                const viewportHeight = window.innerHeight;
                document.documentElement.style.height = `${viewportHeight}px`;
            }, 200);
        });

        // Prevent unwanted touch behaviors on iOS
        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
    </script>
</body>
</html>
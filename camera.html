<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #000;
            position: fixed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        video::-webkit-media-controls {
            display: none !important;
        }

        /* Mirror only in PiP mode */
        :picture-in-picture {
            transform: scaleX(-1);
        }

        .pip-button {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pip-button:hover {
            background: rgba(0,0,0,0.7);
        }

        .pip-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }


    </style>
</head>
<body>
    <div class="video-container">
        <video id="cameraVideo" autoplay playsinline muted disableRemotePlayback></video>
        <button class="pip-button" id="pipBtn">
            <svg viewBox="0 0 24 24">
                <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
            </svg>
            Picture in Picture
        </button>
    </div>

    <script>
        const cameraVideo = document.getElementById('cameraVideo');
        const pipBtn = document.getElementById('pipBtn');
        let currentFacingMode = 'user';

        // Initialize camera
        async function initCamera() {
            try {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { min: 1920, ideal: 3840 },  // 4K support if available
                        height: { min: 1080, ideal: 2160 },
                        frameRate: { ideal: 60 },           // 60fps for smooth video
                        aspectRatio: 16/9,                 // Maintain aspect ratio
                        resizeMode: 'crop-and-scale'       // Ensure full coverage
                    },
                    audio: {
                        echoCancellation: true,      // Reduce echo
                        noiseSuppression: true,      // Reduce background noise
                        autoGainControl: true,       // Automatically adjust volume
                        channelCount: 2,             // Stereo audio
                        sampleRate: 48000,           // High-quality sample rate
                        sampleSize: 16               // 16-bit audio
                    }
                };

                // Function to ensure highest quality
                const ensureHighQuality = async (track) => {
                    const capabilities = track.getCapabilities();
                    const settings = {
                        width: Math.min(capabilities.width?.max || 3840, 3840),
                        height: Math.min(capabilities.height?.max || 2160, 2160),
                        frameRate: Math.min(capabilities.frameRate?.max || 60, 60),
                        resizeMode: 'crop-and-scale'
                    };
                    await track.applyConstraints(settings);
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Apply highest quality settings to video track
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    await ensureHighQuality(videoTrack);
                }

                cameraVideo.srcObject = stream;
                
                // Set video element properties for better quality
                cameraVideo.setAttribute('playsinline', true);
                cameraVideo.setAttribute('webkit-playsinline', true);
                cameraVideo.style.objectFit = 'cover';

                // Hide PiP button if not supported
                if (!document.pictureInPictureEnabled) {
                    pipBtn.style.display = 'none';
                }
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }

        // PiP functionality
        pipBtn.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                        </svg>
                        Picture in Picture`;
                } else if (document.pictureInPictureEnabled) {
                    const pipWindow = await cameraVideo.requestPictureInPicture();
                    // Keep PiP video playing regardless of other media
                    pipWindow.addEventListener('pause', () => {
                        cameraVideo.play().catch(err => console.log('Playback prevented'));
                    });
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/>
                        </svg>
                        Exit PiP`;
                }
            } catch (err) {
                console.error('PiP error:', err);
                alert('Picture-in-Picture mode failed. This feature may not be supported in your browser.');
            }
        });

        // Handle PiP mode changes
        cameraVideo.addEventListener('leavepictureinpicture', () => {
            pipBtn.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Picture in Picture`;
        });

        // Initialize on page load
        // Handle media session
        if ('mediaSession' in navigator) {
            navigator.mediaSession.setActionHandler('pause', () => {
                // Prevent default pause behavior
                cameraVideo.play().catch(err => console.log('Playback prevented'));
            });
        }

        // Ensure video keeps playing when other media starts
        cameraVideo.addEventListener('pause', (event) => {
            // If in PiP mode, force continue playing
            if (document.pictureInPictureElement === cameraVideo) {
                cameraVideo.play().catch(err => console.log('Playback prevented'));
            }
        });

        // Initialize on load
        window.addEventListener('load', async () => {
            await initCamera();
            // Set video to loop and ensure it stays playing
            cameraVideo.loop = true;
        });

        // Handle iOS orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                const viewportHeight = window.innerHeight;
                document.documentElement.style.height = `${viewportHeight}px`;
            }, 200);
        });

        // Prevent unwanted touch behaviors on iOS
        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
    </script>
</body>
</html>
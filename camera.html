<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Camera</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            background: #000;
            position: fixed;
        }

        .video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #cameraVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            /* Mirror the video feed for selfie view */
            transform: scaleX(-1);
        }

        video::-webkit-media-controls {
            display: none !important;
        }
        
        /* PiP should also be mirrored like main video */
        video:picture-in-picture {
            transform: scaleX(-1) !important;
        }
        
        @media all and (display-mode: picture-in-picture) {
            video {
                transform: scaleX(-1) !important;
            }
        }

        .pip-button {
            white-space: nowrap;
            display: inline-flex;
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pip-button:hover {
            background: rgba(0,0,0,0.7);
        }

        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            align-items: center;
            z-index: 1000;
        }

        .pip-container, .light-container {
            display: flex;
            align-items: center;
        }

        .light-button.active {
            background: rgba(255,255,255,0.3);
            box-shadow: 0 0 15px rgba(255,255,255,0.5);
        }

        .light-button.active svg {
            fill: #FFD700;
            opacity: 1;
        }

        .pip-button, .light-button {
            background: rgba(0,0,0,0.5);
            border: none;
            padding: 12px 20px;
            border-radius: 20px;
            color: white;
            font-family: -apple-system, system-ui, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            font-size: 14px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pip-button svg, .light-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }

        .controls-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="video-container">
        <video id="cameraVideo" autoplay playsinline muted="true" defaultMuted disableRemotePlayback></video>
        <div class="controls-container">
            <div class="pip-container">
                <button class="pip-button" id="pipBtn">
                <svg viewBox="0 0 24 24">
                    <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Picture in Picture
            </button>
            </div>
        </div>
    </div>

    <script>
        const cameraVideo = document.getElementById('cameraVideo');
        const pipBtn = document.getElementById('pipBtn');
        let currentFacingMode = 'user';

        // Initialize camera
        async function initCamera() {
            try {
                const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
                
                const constraints = {
                    video: {
                        facingMode: currentFacingMode,
                        width: { min: 1280, ideal: 1920 },  // 1080p quality
                        height: { min: 720, ideal: 1080 },
                        frameRate: { ideal: 60, min: 30 },  // 60fps for smooth video
                        aspectRatio: 16/9,                  // Maintain aspect ratio
                        resizeMode: 'crop-and-scale'        // Ensure full coverage
                    },
                    audio: {
                        echoCancellation: false,           // Disable echo cancellation for mixing
                        noiseSuppression: false,           // Disable noise suppression for natural sound
                        autoGainControl: false,            // Disable auto gain for consistent levels
                        volume: 0.75,                      // Set mic volume to 75%
                        sampleRate: 48000,                 // High quality audio
                        sampleSize: 24,                    // 24-bit audio depth
                        channelCount: 2,                   // Stereo audio
                        latency: 0                         // Minimum latency
                    }
                };

                // Function to ensure highest quality
                const ensureHighQuality = async (track) => {
                    const capabilities = track.getCapabilities();
                    const settings = {
                        width: Math.min(capabilities.width?.max || 1920, 1920),  // Up to 1080p width
                        height: Math.min(capabilities.height?.max || 1080, 1080), // Up to 1080p height
                        frameRate: Math.min(capabilities.frameRate?.max || 60, 60), // Up to 60fps
                        resizeMode: 'crop-and-scale'
                    };
                    await track.applyConstraints(settings);
                };

                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Apply highest quality settings to video track
                const videoTrack = stream.getVideoTracks()[0];
                if (videoTrack) {
                    await ensureHighQuality(videoTrack);
                }

                // Configure audio track for screen recording with mixing
                const audioTrack = stream.getAudioTracks()[0];
                if (audioTrack) {
                    // Set microphone volume to 75% for mixing with device audio
                    await audioTrack.applyConstraints({
                        volume: 0.75,
                        echoCancellation: false,
                        noiseSuppression: false,
                        autoGainControl: false,
                        sampleRate: 48000,
                        sampleSize: 24,
                        latency: 0
                    });
                }

                cameraVideo.srcObject = stream;
                
                // Set video element properties - ensure it's the primary video for PiP
                cameraVideo.setAttribute('playsinline', true);
                cameraVideo.setAttribute('webkit-playsinline', true);
                cameraVideo.style.objectFit = 'cover';
                
                // Mark this video as the preferred PiP source
                cameraVideo.setAttribute('data-pip-source', 'camera');
                cameraVideo.disablePictureInPicture = false;
                
                // Mute the video element to prevent feedback but keep audio track active
                cameraVideo.muted = true;
                
                // Ensure video starts playing immediately
                await cameraVideo.play();

                // Hide PiP button if not supported
                if (!document.pictureInPictureEnabled) {
                    pipBtn.style.display = 'none';
                }
            } catch (err) {
                console.error('Error accessing camera:', err);
                alert('Unable to access camera. Please ensure you have granted camera permissions.');
            }
        }

        // PiP functionality
        pipBtn.addEventListener('click', async () => {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                        </svg>
                        Picture in Picture`;
                } else if (document.pictureInPictureEnabled) {
                    const pipWindow = await cameraVideo.requestPictureInPicture();
                    // Keep PiP video playing regardless of other media and ensure it stays muted
                    pipWindow.addEventListener('pause', () => {
                        cameraVideo.muted = true;
                        cameraVideo.play().catch(err => console.log('Playback prevented'));
                    });
                    
                    // Make PiP mirrored like main video
                    document.pictureInPictureElement.style.transform = 'scaleX(-1)';

                    // Ensure audio stays muted in PiP mode
                    document.pictureInPictureElement.muted = true;
                    
                    // Don't apply additional mirroring in PiP since video is already mirrored
                    pipBtn.innerHTML = `
                        <svg viewBox="0 0 24 24">
                            <path d="M19 11h-8v6h8v-6zm4 8V4.98C23 3.88 22.1 3 21 3H3c-1.1 0-2 .88-2 1.98V19c0 1.1.9 2 2 2h18c1.1 0 2-.9 2-2zm-2 .02H3V4.97h18v14.05z"/>
                        </svg>
                        Exit PiP`;
                }
            } catch (err) {
                console.error('PiP error:', err);
                alert('Picture-in-Picture mode failed. This feature may not be supported in your browser.');
            }
        });

        // Handle PiP mode changes
        cameraVideo.addEventListener('leavepictureinpicture', () => {
            pipBtn.innerHTML = `
                <svg viewBox="0 0 24 24">
                    <path d="M19 7h-8v6h8V7zm2-4H3C2 3 1 4 1 5v14c0 1 1 2 2 2h18c1 0 2-1 2-2V5c0-1-1-2-2-2zm0 16H3V5h18v14z"/>
                </svg>
                Picture in Picture`;
        });

        // Handle media session to allow audio mixing and prevent conflicts
        if ('mediaSession' in navigator) {
            // Don't set any action handlers to avoid conflicts with other media
            navigator.mediaSession.metadata = new MediaMetadata({
                title: 'Camera Feed',
                artist: 'Background Recording',
                artwork: []
            });
        }

        // Prevent video from pausing when other media starts
        cameraVideo.addEventListener('pause', (event) => {
            // Only auto-resume if this is the camera video and not user-initiated
            if (cameraVideo.srcObject && cameraVideo.srcObject.getVideoTracks().length > 0) {
                setTimeout(() => {
                    cameraVideo.play().catch(err => console.log('Camera playback prevented:', err));
                }, 200);
            }
        });

        // Initialize on load
        window.addEventListener('load', initCamera);

        // Handle iOS orientation changes
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                const viewportHeight = window.innerHeight;
                document.documentElement.style.height = `${viewportHeight}px`;
            }, 200);
        });

        // Prevent unwanted touch behaviors on iOS
        document.addEventListener('touchmove', (e) => e.preventDefault(), { passive: false });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STL Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            overflow: hidden;
            background-color: #1e1e1e;
            color: #ffffff;
            font-family: Arial, sans-serif;
        }

        #container {
            position: fixed;
            width: 100%;
            height: 100%;
        }

        #controls {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 100;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 15px;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        button, input[type="file"] {
            padding: 8px 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #45a049;
        }

        input[type="color"] {
            width: 50px;
            height: 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        label {
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="container"></div>
    <div id="controls">
        <div class="control-group">
            <input type="file" id="fileInput" accept=".stl" />
        </div>
        <div class="control-group">
            <label for="bgColor">Background:</label>
            <input type="color" id="bgColor" value="#1e1e1e" />
        </div>
        <div class="control-group">
            <label for="modelColor">Model Color:</label>
            <input type="color" id="modelColor" value="#00ff00" />
        </div>
        <div class="control-group">
            <button id="resetCamera">Reset Camera</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.157.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.157.0/examples/jsm/",
                "three/examples/": "https://unpkg.com/three@0.157.0/examples/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { STLLoader } from 'three/addons/loaders/STLLoader.js';

        // Scene setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('container').appendChild(renderer.domElement);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0x404040);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(1, 1, 1);
        scene.add(directionalLight);

        const pointLight = new THREE.PointLight(0xffffff, 0.5);
        pointLight.position.set(2, 2, 2);
        scene.add(pointLight);

        // Camera and controls setup
        camera.position.z = 5;
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;

        // Variables for model
        let currentModel = null;
        const loader = new STLLoader();

        // Handle file input
        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    loader.load(
                        URL.createObjectURL(file),
                        function(geometry) {
                            // Remove existing model if present
                            if (currentModel) {
                                scene.remove(currentModel);
                            }

                            const material = new THREE.MeshPhongMaterial({
                                color: document.getElementById('modelColor').value,
                                specular: 0x111111,
                                shininess: 200
                            });

                            const mesh = new THREE.Mesh(geometry, material);
                            
                            // Center the model
                            geometry.computeBoundingBox();
                            const center = new THREE.Vector3();
                            geometry.boundingBox.getCenter(center);
                            geometry.center();
                            
                            // Scale model to fit view
                            const boundingBox = new THREE.Box3().setFromObject(mesh);
                            const size = boundingBox.getSize(new THREE.Vector3());
                            const maxDim = Math.max(size.x, size.y, size.z);
                            const scale = 5 / maxDim;
                            mesh.scale.multiplyScalar(scale);

                            currentModel = mesh;
                            scene.add(currentModel);

                            // Reset camera position
                            resetCamera();
                        },
                        (xhr) => {
                            console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                        },
                        (error) => {
                            console.error('Error loading STL:', error);
                        }
                    );
                };
                reader.readAsArrayBuffer(file);
            }
        });

        // Handle background color change
        document.getElementById('bgColor').addEventListener('change', function(event) {
            scene.background = new THREE.Color(event.target.value);
        });

        // Handle model color change
        document.getElementById('modelColor').addEventListener('change', function(event) {
            if (currentModel) {
                currentModel.material.color.setStyle(event.target.value);
            }
        });

        // Reset camera position
        function resetCamera() {
            if (currentModel) {
                const boundingBox = new THREE.Box3().setFromObject(currentModel);
                const center = new THREE.Vector3();
                boundingBox.getCenter(center);
                
                camera.position.set(center.x + 5, center.y + 5, center.z + 5);
                controls.target.copy(center);
                controls.update();
            }
        }

        document.getElementById('resetCamera').addEventListener('click', resetCamera);

        // Handle window resize
        window.addEventListener('resize', onWindowResize, false);

        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }

        // Set initial background color
        scene.background = new THREE.Color(document.getElementById('bgColor').value);

        // Load default STL file if present
        loader.load(
            'cube.stl',
            function(geometry) {
                const material = new THREE.MeshPhongMaterial({
                    color: document.getElementById('modelColor').value,
                    specular: 0x111111,
                    shininess: 200
                });

                const mesh = new THREE.Mesh(geometry, material);
                
                // Center and scale the model
                geometry.computeBoundingBox();
                const center = new THREE.Vector3();
                geometry.boundingBox.getCenter(center);
                geometry.center();
                
                const boundingBox = new THREE.Box3().setFromObject(mesh);
                const size = boundingBox.getSize(new THREE.Vector3());
                const maxDim = Math.max(size.x, size.y, size.z);
                const scale = 5 / maxDim;
                mesh.scale.multiplyScalar(scale);

                currentModel = mesh;
                scene.add(currentModel);
                resetCamera();
            },
            (xhr) => {
                console.log((xhr.loaded / xhr.total * 100) + '% loaded');
            },
            (error) => {
                console.log('No default STL file found, waiting for user input');
            }
        );

        animate();
    </script>
</body>
</html>